<!DOCTYPE html>
<html>

<head>
    <title> GENERATE MARKER ENGINE</title>
    <!-- All local includes -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
    <script src="./scripts/jquery.min.js"></script>
    <link rel="stylesheet" href="./styles/bootstrap.css" />
    <script src="./scripts/bootstrap.min.js"></script>

</head>

<body>
    <div class="container">
        <div class="table-responsive">
            <h1 align="center">Here we read and format file data.</h1>
            <br />
            <div align="center">
                <button type="button" name="load_data" id="load_data" class="btn btn-info">Load Data</button>
            </div>
            <br />
        </div>
    </div>

    <includes>

    </includes>

    <div id="map"></div>


</body>

</html>

<script>

    function initMap() { }

    /** MAP MARKER GENERATION FOR FEEDBC INTERACTIVE FOODMAP - 2023
     * 
     * Welcome to the beginning of this script! 
     * 
     * If you have any questions, contact me at the address below.
     * @author Ezra Boersma <ezra.boersma@itas.ca>
     * 
     * This script is intended to serve the function of allowing the Food Services department (or responsible party) to be able to dynamically 
     * update and create map markers with information about local suppliers and sourced ingredients.
     * It allows the admin to use Microsoft Excel to update a worksheet with new information needed to create or modify the map markers.
     * 
     * This information can be easily gathered from the supplier website, and the google maps location pin for the business adress listed on the site. 
     * 
     *              *****----   READ BEFORE MAKING ANY CHANGES TO EXCEL DATA   ----*****
     * 
     * Before Updating Data, there are THREE IMPORTANT THINGS to remember!
     * 1.) In Microsoft Excel, go to File > Options > Advanced
     *      At the bottom of the 'Editing options' section, do the following:
     *          - Check "Use system separators"
     *          - Set the Decimal separator to COMMA ,
     *          - Set the Thousands separator to DECIMAL .
     *               Then click OK. Then save the worksheet as a UTF-8 CSV file.
     *              This will set the system delimiter to a semicolon. Reverse the process if you need to revert it on your system.
     * 
     * 2.) ALL images MUST be JPG format.
     * 
     * 
     * 3.) Do not leave empty cells of data. Website is fine, but all columns need to have data for each supplier.
     * 
     * 
     *          
     *              *****----   INFORMATION REQUIRED FOR UPDATING OR CREATING NEW SUPPLIERS   ----*****
     * 
     *  - Supplier Name
     * 
     *  - Address ( Information available on supplier site or Google Maps   )
     * 
     *  - Coordinates ( Right click pin on google maps and copy the Lat,Long coordinates AS IS  )
     * 
     *  - Ingredients ( Simple list of ingredients or product category supplied )
     * 
     *  - Description ( From the site, or in our own words. Try to keep it simple. 1-2 paragraphs.  )
     * 
     *  - Image Name (  Choose any image you want to use. You MUST save the file as a JPG.
     *                    Save it as as something like: fredrichs.jpg
     *                  Move this file to the "images" folder of this project.
     *                  On the Excel sheet, simply type the name: fredrichs   )
     *                  
     *  - Image Description (   Accessibility Feature : The description of the image that screen readers will use   )
     * 
     * 
     * 
     * */


    /** Load the CSV data and split it into arrays of data for processing later. */

    $(document).ready(function () {
        $('#load_data').click(function () {
            $.ajax({
                //This is a SEMICOLON DELIMITED CSV file in the ROOT FOLDER. 
                //TODO: Nest this to prevent shallow visibility.
                url: "./files/suppliers/supplier_markers.csv",

                //type of data to expect
                dataType: "text",

                //success will run a function when the pairs above resolve successfully
                success: function (data) {

                    console.log("Code  is  running...");
                    // split file into entries by linebreak
                    var supplier_list = data.split(/\r?\n|\r/);
                    const supplier_dataset = [];


                    var suppliers = [];
                    for (var counter = 0; counter < supplier_list.length; counter++) {
                        // Split the supplier_list into entries. This is another Array containinf the information for one supplier.



                        if ((counter === 0) || (supplier_list[counter] === '')) { //SKIP HEADERS or EMPTY LEADING CELLS.

                            continue;

                        }



                        suppliers.push(supplier_list[counter].split(";")); //the array of our formatted suppliers, ready to write data to new arrays.

                    }


                    console.log("Logging suppliers variable after split: " + suppliers);

                    console.table(suppliers);

                    //These are the arrays that will store the elements that we create from the CSV data. 
                    //We will call on these to create our Markers, Legend Items, Infowindows, contentStrings, 
                    var stringArray = [],
                        markerArray = [],
                        legendArray = [];


                    suppliers.forEach((cell, cell_count) => {

                        const title = cell[0],
                            address = cell[1],
                            coords = new google.maps.LatLng(cell[2]),
                            ingredients = cell[3],
                            description = cell[4],
                            imgpath = cell[5],
                            imgdesc = cell[6];

                        /** Check All Data we have read in - send an alert when we encounter empty cells, and tell the user what to fix. 
                         *  THIS WILL SKIP THE WEB LINK IN THE CHECK - SEE NOTES BELOW
                         * 
                         */
                        for (var i = 0; i <= 5; i++) { //Increase this to 6 to include the web link column in the check
                            if (cell[i] === '') {
                                alert(`There is a cell at row ${cell_count + 2} in column ${i + 1} which requires data.\n Please enter this data and re-upload your file.`);

                            }

                        }


                        var currDataID = title.replace(/[^a-zA-Z0-9]/g, ''); //Strip name of all spaces and characters
                        currDataID = currDataID.charAt(0) + currDataID.substring(1).toLowerCase();
                        /**TODO: push this to array for this object???? */





                        const contentString =
                            '<div id="content" class="container">' +
                            '<div id="siteNotice">' +
                            "</div>" +
                            '<div class="row mb-3">' +
                            '<div class="col-lg-12">' +
                            `<h1 id="firstHeading" class="firstHeading mt-1">${title}</h1>` + //
                            `<h6 id="addrHeading" class="addrHeading">${address}</h6>` + //
                            '<div class="row gy-2">' +
                            '<div class="col-md-6">' +

                            `<img src="../images/${imgpath}.jpg" class="h-auto w-100 rounded mx-auto d-block mt-5" alt="${imgdesc}"></img>` +

                            '</div>' +

                            '<div class="col-md-6">' +
                            '<div id="bodyContent" class="h-auto w-100">' +

                            `<p class="gy-3 mt-5"><span class="align-middle">
                                <br><br><br>
                                <span class="fw-bold">Local Ingredient(s): ${ingredients}.</span>
                                ${description}
                                </span></p>`+

                            '</div>' +

                            '</div>' +
                            '</div>' +

                            '</div>' +
                            '</div>';
                        '</div>';

                        console.log(contentString);
                        stringArray.push(contentString);
                        console.log(stringArray);




                        const legendString = `<li id="${currDataID}"` +
                            'class="list-group-item d-flex justify-content-between align-items-center supplier-item" >' +
                            `<button type="button" class="list-group-item list-group-item-action">${title}</button>` +
                            `<span class="badge bg-primary rounded-pill">${cell_count + 1}</span>` +
                            '</li >';


                        console.log(legendString);
                        legendArray.push(legendString);
                        console.log(legendArray);







                        // Create the markers.
                        const pinView = new google.maps.marker.PinView({
                            glyph: `${cell_count + 1}`,
                        });
                        const marker = new google.maps.marker.AdvancedMarkerView({
                            coords,
                            map,
                            title: `${cell_count + 1}. ${title}`,
                            content: pinView.element,
                        });

                        // Add a click listener for each marker, and set up the info window.
                        marker.addListener("click", ({ domEvent, latLng }) => {
                            const { target } = domEvent;

                            infoWindow.close();
                            infoWindow.setContent(stringArray[(marker.glyph - 1)]);
                            infoWindow.open(marker.map, marker);
                        });



                        document.getElementById(currDataID).onclick = function () {
                            infowindow.open({
                                anchor: (cell_count + 1),
                                map,
                            })
                        };




                        console.log(marker);
                        markerArray.push(marker);
                        console.log(markerArray);









                    })


                    //* Push elements from arrays into respective containers/functions (some don't need any manipulation - they simply need be instantiated  */



                }
            });
        });

    });
    initMap();

</script>
<!-- Remember to change YOUR_API_KEY below! -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAh7Yk_WZh5s3nWzWjjJsLcbBDfqdrlens&callback=initMap" async
    defer></script>

<!--    The `defer` attribute causes the callback to execute after the full HTML
                  document has been parsed. For non-blocking uses, avoiding race conditions,
                  and consistent behavior across browsers, consider loading using Promises
                  with https://www.npmjs.com/package/@googlemaps/js-api-loader.
                  -->